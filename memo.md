#### 2dporous-wd-change.f

２次元のポーラスディスクモデル、KK-scheme改

##### 計算領域

- 分割数　NX=1501 x NY=1001
- 領域　$X_{LEN}=15 \times Y_{LEN}=10$　（無次元）
- $X_{LEN}$をNX-1で分割し格子幅$\Delta x=0.01$とする

##### 計算格子

- $X \in [-5, 15],\,Y \in[-5,10]$の領域をとり、座標$(0,0)$が風車位置
- 直交等間隔格子
- スタガード配置

##### ポーラスディスク

- `IA=500, IB=502`, `JA=426, JB=576`のインデクス範囲
- x方向２セル（3点）、y方向149セル（150点）の範囲
- 大きさにして$0.02 \times 1.5$​
- `pfunc.dat`の内容をファイルから読み込み、風車の直径方向（インデクスＪ）の分布として$Pfunc \times C_{DD}$の値で`DFUNC(i,j)`に保存
- $F_i=-C_{RC} \cdot f(\frac{y}{R},\frac{z}{R}) \cdot \bar{u_i}V,\quad V=\sqrt{\bar{u}^2+\bar{v}^2+\bar{w}^2}$​
- Pfuncのデータは関数$f$の分布形状で$0\sim 1$のガウス分布

##### 流入条件

- `time-hist-inflow_5.0deg.dat`にu, vの時刻履歴が書かれており、これを`UUIN(t),VVIN(t)`に読み込んで各時刻の境界条件として使う
- ガイドセルに値を入れる

##### 流出条件

- `i=NX`についてはUは対流流出、Vはノイマン
- `i=NX+1`以降についてはノイマン

##### 平均値

- `UAVE, VAVE, PAVE`の各配列に保持

##### 線形計算　

- SOR法で不足緩和 $\omega=0.9, \varepsilon=1.0\times 10^{-3}$​​ 
- 最大反復回数100回

##### 計算パラメータ

- 計算ステップ数：320000
- 積分幅 $\Delta t=1.0\times 10^{-3}$​ Courant数にして0.1
- レイノルズ数$10^4$​
- $C_{DD}=13.0$

##### 計算ループ

- 配列範囲
  - `(0:NX+2)`
- 内点
  - `U: (2:NX-1,2:NY)`
  - `V: (2:NX,2:NY-1)`
  - `P: (2:NX, 2:NY)`



圧力は全周ノイマンで、空間平均値で引き戻す



境界値`P(1,j), P(NX+1,j), P(i,1), P(i,NY+1)`ノイマン条件

可視化データを`IPROG=800`ステップ毎に生成

可視化のためにセルセンターの速度を算術平均で作り、出力



##### 時間平均

- UAVEに値を足し込み、終了時に平均化



##### ログ

NSOR=100ステップ毎にCD、圧力反復回数、変化量のrmsをモニタに出力



### オリジナルの確認

- ITOサブシステムＡ１ノードを利用

##### コンパイル

~~~
$ module load oneapi/2022.3.1
$ pwd
/home/usr0/k70000a/RC2d/origin

$ cat Makefile
SHELL=/bin/bash

SRCS = 2dporous-wd-change.f

.SUFFIXES: .o .cpp .f90 .f
OBJS = $(SRCS:.f=.o)

FC  =	ifort
CMD =	2dp

FFLAGS =  -ipo -O3 -no-prec-div -fp-model fast=2 -xHost -fixed
LDFLAGS =
LIBS   =

$(CMD):	$(OBJS)
	$(FC) $(FFLAGS) -o $(@) $(OBJS) $(LDFLAGS) $(LIBS)

.f.o:
	$(FC) $(FFLAGS) -c $<

clean:
	$(RM) $(OBJS) $(TARGET)
	
$ cat go.sh
#!/bin/bash
#PJM -L "rscunit=ito-a"
#PJM -L "rscgrp=ito-ss"
#PJM -L "vnode=1"
#PJM -L "vnode-core=36"
#PJM -L "elapse=08:00:00"
#PJM -j
#PJM -X
#PJM -S

module load oneapi/2022.3.1
./2dp

$ ls
2dp                         // 実行モジュール
2dporous-wd-change.f        // ソースコード
3d-inst-vis.dat             // 瞬間データ
3d-tave-vis.dat             // 時間平均データ
5D-10D-U-profile.dat        // 5D後方の速度プロファイル
Makefile                    // 
go.sh                       // バッチジョブファイル
go.sh.i29469700             // 実行情報
go.sh.o29469700             // 実行モニタ出力
pfunc.dat                   // 入力ファイル　PDMのプロファイル
time-hist-inflow_5.0deg.dat // 入力ファイル　流入変動風
~~~

### PMlibによるプロファイリング

- ソースコードをf90形式に書き換え
- 不要な配列の除去
- PMlib関数の挿入
- `2dporous-wd-change_pm.f90`

#### PMlibのコンパイル

- Intel compiler逐次計算

~~~
$ module load oneapi/2022.3.1
$ pwd
/home/usr0/k70000a/PMlib-6.3.0
$ mkdir BUILD
$ cd BUILD
$ export PM_HOME=/home/usr0/k70000a
$ export CC=icc CXX=icpc F90=ifort FC=ifort
$ cmake -DINSTALL_DIR=${PM_HOME}/PMlib \
	-Denable_OPENMP=yes \
	-Dwith_MPI=no \
	-Denable_Fortran=yes \
	-Dwith_example=no \
	-Dwith_PAPI=no \
	-Dwith_OTF=no \
  -Denable_PreciseTimer=yes ..

PMlibのコンパイルオプション
CMAKE_CXX_FLAGS   :  -xHOST -O3 -qopt-report=3 -DDISABLE_MPI -DUSE_PRECISE_TIMER
CMAKE_Fortran_FLAGS    :  -fpp -xHOST -O3 -qopt-report=3 -free -DDISABLE_MPI

$ make
$ make install

~~~

#### ソースコードのコンパイル

~~~
$ pwd
/home/usr0/k70000a/RC2d/org_pm
$ cat Makefile
SHELL=/bin/bash

SRCS = 2dporous-wd-change_pm.f90

.SUFFIXES: .o .cpp .f90
OBJS = $(SRCS:.f90=.o)

FC  =	ifort
CMD =	2dp

FFLAGS =  -ipo -O3 -no-prec-div -fp-model fast=2 -xHost -free
LDFLAGS = -L/home/usr0/k70000a/PMlib/lib -lPM -lstdc++
LIBS   =

$(CMD):	$(OBJS)
	$(FC) $(FFLAGS) -o $(@) $(OBJS) $(LDFLAGS) $(LIBS)

.f90.o:
	$(FC) $(FFLAGS) -c $<

clean:
	$(RM) $(OBJS) $(TARGET)
	
$ make
$ ls
2dp  
2dporous-wd-change_pm.f90  
Makefile  
go.sh  
pfunc.dat  
time-hist-inflow_5.0deg.dat
~~~



#### 富士通コンパイラ

~~~
$ export CC=fcc CXX=FCC F90=frt FC=frt
$ cmake -DINSTALL_DIR=${PM_HOME}/PMlib \
            -DCMAKE_TOOLCHAIN_FILE=../cmake/Toolchain_intel_F_TCS.cmake \
            -Denable_OPENMP=yes \
            -Dwith_MPI=no \
            -Denable_Fortran=yes \
            -Dwith_example=no \
            -Dwith_PAPI=no \
            -Dwith_OTF=no \
            -Denable_PreciseTimer=no ..

CMAKE_C_FLAGS     :  -Kfast -Nrt_notune -w -Xg -Kopenmp -DDISABLE_MPI
CMAKE_CXX_FLAGS   :  -Kfast -Nrt_notune -w -Xg -Nfjcex -Kopenmp -DDISABLE_MPI -DUSE_PRECISE_TIMER
CMAKE_Fortran_FLAGS    :-Cpp -Kfast -Nrt_notune -Knooptmsg -Free -Kopenmp -DDISABLE_MPI
~~~

- **いずれのコンパイラもf_pm_print()時にエラーがでるのでPMlibを諦める。**

#### 代わりにオレオレPMlib

- f90で簡易的なPMlibもどきを`2dporous-wd-change_pm2.f90`に実装。
- OpenMPの時刻APIを利用

~~~
                Label     Call        accTime        avrTime   flop/call    Gflops
Initial-section              1    0.26146E+00    0.26146E+00   0.000E+00     0.000
meshing                      1    0.10000E-03    0.10000E-03   0.902E+07    90.150
read_data                    1    0.23786E+00    0.23786E+00   0.000E+00     0.000
init_arrays                  1    0.23327E-01    0.23327E-01   0.000E+00     0.000
read_rst_file                1    0.10000E-03    0.10000E-03   0.000E+00     0.000
TimeStep-Loop              100    0.36378E+01    0.36378E-01   0.000E+00     0.000
str_Nstep                  100    0.51690E+00    0.51690E-02   0.000E+00     0.000
Uflux                      100    0.42172E+00    0.42172E-02   0.160E+09    38.033
Vflux                      100    0.41453E+00    0.41453E-02   0.160E+09    38.680
Poi_RHS                    100    0.23906E+00    0.23906E-02   0.105E+08     4.392
Poisson-Iteration          100    0.81617E+00    0.81617E-02   0.200E+01     0.000
Poi_AXB                    105    0.85688E+00    0.81607E-02   0.210E+08     2.573
Avr_Prs                    100    0.88006E-01    0.88006E-03   0.151E+07     1.710
Shift_Prs                  100    0.82155E-01    0.82155E-03   0.452E+07     5.496
BC_Prs                     100    0.12467E-02    0.12467E-04   0.000E+00     0.000
Update_Vec                 100    0.29841E+00    0.29841E-02   0.120E+08     4.018
BC_Vec                     100    0.73369E-02    0.73369E-04   0.800E+04     0.109
stg2CC                     100    0.39299E+00    0.39299E-02   0.601E+07     1.529
accumAvr                   100    0.31728E+00    0.31728E-02   0.301E+07     0.947
display                      1    0.96297E-03    0.96297E-03   0.000E+00     0.000
cal_VisIns                   0    0.10000E-03       Infinity   0.000E+00     0.000
wrt_VisIns                   0    0.10000E-03       Infinity   0.000E+00     0.000
Post-section                 1    0.14106E+00    0.14106E+00   0.000E+00     0.000
averaging                    1    0.16820E-02    0.16820E-02   0.301E+07     1.787
wrt_Profile                  1    0.61175E-01    0.61175E-01   0.000E+00     0.000
cal_VisAvr                   1    0.12695E-01    0.12695E-01   0.000E+00     0.000
wrt_VisAvr                   1    0.65507E-01    0.65507E-01   0.000E+00     0.000
~~~

- %割合とソートを実装。
- inclusive区間はない仕様



##### origin	

- `2dporous-wd-change.f`
- オリジナルコード、リファレンスデータ
- ITO-a逐次計算, 320,000step
  - ELAPSE TIME (USE)         : 02:57:39 (10659 sec)
  - MAX MEMORY SIZE (USE)     : 253.0 MiB

##### org_pm	

- `2dporous-wd-change_pm2.f90`
- オリジナルコードと等価の計時ルーチン入り
- SOR部が3Gflops程度、2-color化
- UO,VOへのコピーが遅い。２つのループに分ける、１次元化、memcopyなどトライ

##### mdfy1	

- `2dporous-wd-change_pm_sub.f90`
- `2dporous-wd-change_pm2.f90`をサブルーチン化

##### mdfy2

- `2dpdm.f90`
- SPHフォーマット出力追加
- 1000 stepで評価
- store_vel
  - store_vel　オリジナル >>`2dp0`
  - store_vel2　UとVのコピーを分ける >> `2dp2`
  - store_vel3　１次元化 >> `2dp3`
- SOR
  - Poisson_AXB　オリジナル
  - Poisson_AXB2C　RB-SOR

##### 結果比較

| Vel         | Vel2        | Vel3 (2-loops) | vel,intent  | Vel3, 1-loop |
| ----------- | ----------- | -------------- | ----------- | ------------ |
| 0.33658E+01 | 0.47179E+01 | 0.47102E+01    | 0.33641E+01 | 0.33407E+01  |

- 一つのループの中でまとめてコピーを行い、１次元化が早い



| SOR         | RB-SOR      |
| ----------- | ----------- |
| 0.66674E+01 | 0.39732E+01 |

- 5Dと10Dの結果を比較すると、両者はほぼ同じ結果となる（$10^{-5}$のオーダーで速度成分が異なる程度）。



###### org_pm

~~~
                Label  %Time      Call        accTime        avrTime   flop/call    Gflops
Poi_AXB                23.20    320005    0.26123E+04    0.81632E-02   0.210E+08     2.573
str_Nstep              14.12    320000    0.15901E+04    0.49690E-02   0.000E+00     0.000
Uflux                  11.76    320000    0.13247E+04    0.41398E-02   0.160E+09    38.744
Vflux                  11.66    320000    0.13133E+04    0.41042E-02   0.160E+09    39.067
stg2CC                 10.74    320000    0.12096E+04    0.37799E-02   0.601E+07     1.590
accumAvr                8.69    320000    0.97883E+03    0.30588E-02   0.301E+07     0.982
Update_Vec              8.15    320000    0.91799E+03    0.28687E-02   0.120E+08     4.180
Poi_RHS                 6.44    320000    0.72507E+03    0.22659E-02   0.105E+08     4.634
Avr_Prs                 2.43    320000    0.27352E+03    0.85474E-03   0.151E+07     1.761
Shift_Prs               2.28    320000    0.25710E+03    0.80343E-03   0.452E+07     5.620
wrt_VisIns              0.25       400    0.27609E+02    0.69023E-01   0.000E+00     0.000
BC_Vec                  0.19    320000    0.21690E+02    0.67783E-04   0.800E+04     0.118
BC_Prs                  0.04    320000    0.40813E+01    0.12754E-04   0.000E+00     0.000
cal_VisIns              0.03       400    0.37690E+01    0.94226E-02   0.000E+00     0.000
display                 0.01      3200    0.15882E+01    0.49631E-03   0.000E+00     0.000
read_data               0.00         1    0.26450E+00    0.26450E+00   0.000E+00     0.000
wrt_VisAvr              0.00         1    0.10341E+00    0.10341E+00   0.000E+00     0.000
wrt_Profile             0.00         1    0.31946E-01    0.31946E-01   0.000E+00     0.000
init_arrays             0.00         1    0.23531E-01    0.23531E-01   0.000E+00     0.000
cal_VisAvr              0.00         1    0.12957E-01    0.12957E-01   0.000E+00     0.000
averaging               0.00         1    0.16921E-02    0.16921E-02   0.301E+07     1.776
read_rst_file           0.00         1    0.10000E-02    0.10000E-02   0.000E+00     0.000
meshing                 0.00         1    0.10000E-02    0.10000E-02   0.902E+07     9.015
~~~

###### mdfy2

~~~
                Label  %Time      Call        accTime        avrTime   flop/call    Gflops
Uflux                  14.00    320000    0.13297E+04    0.41552E-02   0.160E+09    38.600
Vflux                  13.91    320000    0.13213E+04    0.41292E-02   0.160E+09    38.831
Poi_AXB                13.64    320005    0.12953E+04    0.40478E-02   0.210E+08     5.188
stg2CC                 13.54    320000    0.12860E+04    0.40189E-02   0.601E+07     1.495
str_Nstep              12.41    320000    0.11786E+04    0.36833E-02   0.000E+00     0.000
accumAvr               10.23    320000    0.97173E+03    0.30366E-02   0.301E+07     0.990
Update_Vec              9.48    320000    0.89985E+03    0.28120E-02   0.120E+08     4.264
Poi_RHS                 7.83    320000    0.74331E+03    0.23228E-02   0.105E+08     4.520
Shift_Prs               4.12    320000    0.39103E+03    0.12220E-02   0.602E+07     4.926
wrt_SPHIns              0.56       400    0.53427E+02    0.13357E+00   0.000E+00     0.000
BC_Vec                  0.23    320000    0.21962E+02    0.68631E-04   0.800E+04     0.117
BC_Prs                  0.03    320000    0.28868E+01    0.90214E-05   0.000E+00     0.000
display                 0.02      3200    0.14903E+01    0.46571E-03   0.000E+00     0.000
read_inflow             0.00         1    0.21401E+00    0.21401E+00   0.000E+00     0.000
wrt_SPHAvr              0.00         1    0.89315E-01    0.89315E-01   0.000E+00     0.000
wrt_Profile             0.00         1    0.47946E-01    0.47946E-01   0.000E+00     0.000
init_arrays             0.00         1    0.22898E-01    0.22898E-01   0.000E+00     0.000
setup_PDM               0.00         1    0.19241E-01    0.19241E-01   0.000E+00     0.000
averaging               0.00         1    0.16961E-02    0.16961E-02   0.301E+07     1.772
meshing                 0.00         1    0.12228E-02    0.12228E-02   0.902E+07     7.372
read_rst_file           0.00         0    0.10000E-02       Infinity   0.000E+00     0.000
wrt_RCSAvr              0.00         0    0.10000E-02       Infinity   0.000E+00     0.000
wrt_RCSIns              0.00         0    0.10000E-02       Infinity   0.000E+00     0.000
~~~



- stg2CCはスタガード位置から右上ノード点への補間→変数U, V。この変数は時間平均と出力に使われる。時間平均はスタガード位置で積算し、必要なときだけstg2CCをコールすることで時間を削減できる。空間平均値の時間平均操作と時間平均値の空間平均操作の違いは統計的には違いはないはず。
- この変更に伴いUAVEの配列の大きさをUUと同じにする
- accumVar(), avrVars()の範囲を＋１
- strNstepは{UU, VV}→{UO, VO}のコピー操作だけであるのにflux計算とほぼ同じ時間コスト！
  - j方向のストライドアクセスのためか？

##### mdfy3

- `2dpdm2.f90`
- stg2Nodeのコール回数を削減
- intentの指示追加

~~~
                Label  %Time      Call        accTime        avrTime   flop/call    Gflops
Vflux                  16.15    320000    0.13209E+04    0.41277E-02   0.160E+09    38.844
Uflux                  16.14    320000    0.13202E+04    0.41255E-02   0.160E+09    38.878
Poi_AXB                15.81    320005    0.12937E+04    0.40428E-02   0.210E+08     5.194
str_Nstep              14.31    320000    0.11705E+04    0.36577E-02   0.000E+00     0.000
accumAvr               11.92    320000    0.97513E+03    0.30473E-02   0.301E+07     0.986
Update_Vec             10.88    320000    0.89004E+03    0.27814E-02   0.120E+08     4.311
Poi_RHS                 8.84    320000    0.72332E+03    0.22604E-02   0.105E+08     4.645
Shift_Prs               4.77    320000    0.39004E+03    0.12189E-02   0.602E+07     4.939
wrt_SPHIns              0.83       400    0.68248E+02    0.17062E+00   0.000E+00     0.000
BC_Vec                  0.27    320000    0.22115E+02    0.69109E-04   0.800E+04     0.116
BC_Prs                  0.04    320000    0.29927E+01    0.93522E-05   0.000E+00     0.000
stg2Node                0.02       400    0.17670E+01    0.44174E-02   0.601E+07     1.361
display                 0.02      3200    0.16376E+01    0.51175E-03   0.000E+00     0.000
read_inflow             0.00         1    0.25133E+00    0.25133E+00   0.000E+00     0.000
wrt_SPHAvr              0.00         1    0.13478E+00    0.13478E+00   0.000E+00     0.000
wrt_Profile             0.00         1    0.30588E-01    0.30588E-01   0.000E+00     0.000
setup_PDM               0.00         1    0.27750E-01    0.27750E-01   0.000E+00     0.000
init_arrays             0.00         1    0.24238E-01    0.24238E-01   0.000E+00     0.000
averaging               0.00         1    0.16489E-02    0.16489E-02   0.301E+07     1.822
read_rst_file           0.00         0    0.10000E-02       Infinity   0.000E+00     0.000
wrt_RCSIns              0.00         0    0.10000E-02       Infinity   0.000E+00     0.000
wrt_RCSAvr              0.00         0    0.10000E-02       Infinity   0.000E+00     0.000
meshing                 0.00         1    0.10000E-02    0.10000E-02   0.902E+07     9.015
~~~





##### mdfy4

- `2dpdm3.f90`
- UAVE(NX,NY)→UAVE(0:NX+2,0:NY+2)に変更
- `size.fi`をインクルードし各ルーチンのコンパイルを最適化

~~~
                Label  %Time      Call        accTime        avrTime   flop/call    Gflops
Vflux                  16.59    320000    0.13481E+04    0.42128E-02   0.160E+09    38.060
Uflux                  16.58    320000    0.13467E+04    0.42084E-02   0.160E+09    38.113
Poi_AXB                16.12    320005    0.13094E+04    0.40918E-02   0.210E+08     5.132
str_Nstep              12.92    320000    0.10499E+04    0.32808E-02   0.000E+00     0.000
accumAvr               11.87    320000    0.96419E+03    0.30131E-02   0.301E+07     0.997
Update_Vec             11.00    320000    0.89378E+03    0.27931E-02   0.120E+08     4.293
Poi_RHS                 8.90    320000    0.72313E+03    0.22598E-02   0.105E+08     4.646
Shift_Prs               4.81    320000    0.39104E+03    0.12220E-02   0.602E+07     4.926
wrt_SPHIns              0.79       400    0.63990E+02    0.15997E+00   0.000E+00     0.000
BC_Vec                  0.28    320000    0.22393E+02    0.69979E-04   0.800E+04     0.114
display                 0.08      3200    0.66627E+01    0.20821E-02   0.000E+00     0.000
BC_Prs                  0.04    320000    0.31190E+01    0.97469E-05   0.000E+00     0.000
stg2Node                0.02       400    0.18688E+01    0.46720E-02   0.601E+07     1.286
read_inflow             0.00         1    0.17691E+00    0.17691E+00   0.000E+00     0.000
wrt_SPHAvr              0.00         1    0.71183E-01    0.71183E-01   0.000E+00     0.000
wrt_Profile             0.00         1    0.49685E-01    0.49685E-01   0.000E+00     0.000
init_arrays             0.00         1    0.24554E-01    0.24554E-01   0.000E+00     0.000
setup_PDM               0.00         1    0.18536E-01    0.18536E-01   0.000E+00     0.000
averaging               0.00         1    0.16990E-02    0.16990E-02   0.301E+07     1.769
read_rst_file           0.00         0    0.10000E-02       Infinity   0.000E+00     0.000
wrt_RCSIns              0.00         0    0.10000E-02       Infinity   0.000E+00     0.000
wrt_RCSAvr              0.00         0    0.10000E-02       Infinity   0.000E+00     0.000
meshing                 0.00         0    0.10000E-02       Infinity   0.902E+07     0.000
~~~





##### 時間比較

|                                     | time (sec) | memory (MiB) |
| ----------------------------------- | ---------- | ------------ |
| org_pm (2dporous-wd-change_pm2.f90) | 11,264     | 220.6        |
| mdfy2 (2dpdm.f90)                   | 9,500      | 219.4        |
| mdfy3 (2dpdm2.f90)                  | 8,183      | 230.2        |
| Mdfy4 (2dpdm3.f90)                  | 8,128      | 237.4        |

- 

##### scaletest

- `2dpdm4.f90` OpenMPディレクティブ挿入＋演算の省力化

| #core | 2dpdm4 (sec) | Ratio | Flux   | strNstep | accumAvr |
| ----- | ------------ | ----- | ------ | -------- | -------- |
| 1     | 8,437        | 1.0   |        |          |          |
| 2     | 3,949        | 2.14  | 665.78 | 652.78   | 447.85   |
| 4     | 2,053        | 4.11  | 342.30 | 349.75   | 226.26   |
| 6     | 1,444        | 5.84  |        |          |          |
| 8     | 1,092        | 7.73  | 180.54 | 192.29   | 119.63   |
| 10    | 901          | 9.36  |        |          |          |
| 12    | 765          | 11.03 |        |          |          |
| 14    | 672          | 12.56 |        |          |          |
| 16    | 667          | 12.65 | 107.49 | 123.97   | 99.94    |
| 18    | 596          | 14.16 | 96.95  | 112.25   | 90.88    |
| 20    | 513          | 16.45 |        |          |          |
| 22    | 487          | 17.32 |        |          |          |
| 24    | 462          | 18.26 |        |          |          |
| 26    | 444          | 19.00 |        |          |          |
| 28    | 428          | 19.71 |        |          |          |
| 30    | 411          | 20.53 |        |          |          |
| 32    | 410          | 20.58 | 63.65  | 78.21    | 70.38    |
| 34    | 398          | 21.20 |        |          |          |
| 36    | 374          | 22.56 | 56.41  | 68.12    | 62.73    |



##### 36スレッド時のプロファイル

~~~
                Label  %Time      Call        accTime        avrTime   flop/call    Gflops
str_Nstep              18.31    320000    0.68123E+02    0.21288E-03   0.000E+00     0.000
accumAvr               16.86    320000    0.62729E+02    0.19603E-03   0.301E+07    15.329
Uflux                  15.17    320000    0.56411E+02    0.17628E-03   0.160E+09   909.861
Poi_AXB                14.94    320005    0.55574E+02    0.17367E-03   0.210E+08   120.922
Vflux                  13.96    320000    0.51914E+02    0.16223E-03   0.160E+09   988.340
Poi_RHS                 9.42    320000    0.35045E+02    0.10951E-03   0.105E+08    95.877
Update_Vec              6.35    320000    0.23603E+02    0.73759E-04   0.120E+08   162.556
Shift_Prs               2.76    320000    0.10267E+02    0.32085E-04   0.602E+07   187.628
BC_Vec                  1.02    320000    0.38045E+01    0.11889E-04   0.800E+04     0.673
BC_Prs                  0.98    320000    0.36595E+01    0.11436E-04   0.000E+00     0.000
display                 0.11      3200    0.39550E+00    0.12359E-03   0.000E+00     0.000
setup_PDM               0.06         1    0.20879E+00    0.20879E+00   0.000E+00     0.000
read_inflow             0.04         1    0.13160E+00    0.13160E+00   0.000E+00     0.000
wrt_SPHAvr              0.02         1    0.62639E-01    0.62639E-01   0.000E+00     0.000
wrt_Profile             0.01         1    0.33376E-01    0.33376E-01   0.000E+00     0.000
init_arrays             0.00         1    0.44479E-02    0.44479E-02   0.000E+00     0.000
meshing                 0.00         0    0.10000E-02       Infinity   0.902E+07     0.000
wrt_RCSIns              0.00         0    0.10000E-02       Infinity   0.000E+00     0.000
wrt_SPHIns              0.00         0    0.10000E-02       Infinity   0.000E+00     0.000
averaging               0.00         1    0.10000E-02    0.10000E-02   0.301E+07     3.005
stg2Node                0.00         0    0.10000E-02       Infinity   0.601E+07     0.000
wrt_RCSAvr              0.00         0    0.10000E-02       Infinity   0.000E+00     0.000
read_rst_file           0.00         0    0.10000E-02       Infinity   0.000E+00     0.000
=================================================
Elapsed time =       0.372E+03
~~~

- `Str_Nstep`と``accumAvr`のルーチンが遅い



##### mdfy5

- strNstepについて、ポインタで付け替え　`2dpdm5.f90`
- 時間削減された！　が、Poi_AXBの回数が増えてておかしい

~~~
                Label  %Time      Call        accTime        avrTime   flop/call    Gflops
Uflux                  19.70    320000    0.67762E+02    0.21175E-03   0.160E+09   757.447
accumAvr               19.28    320000    0.66315E+02    0.20723E-03   0.301E+07    14.500
Poi_AXB                18.06    337255    0.62107E+02    0.18415E-03   0.210E+08   114.035
Vflux                  16.79    320000    0.57749E+02    0.18046E-03   0.160E+09   888.484
Poi_RHS                13.14    320000    0.45207E+02    0.14127E-03   0.105E+08    74.324
Update_Vec              7.50    320000    0.25789E+02    0.80591E-04   0.120E+08   148.776
Shift_Prs               3.20    320000    0.11001E+02    0.34377E-04   0.602E+07   175.118
BC_Prs                  1.06    320000    0.36487E+01    0.11402E-04   0.000E+00     0.000
BC_Vec                  1.00    320000    0.34273E+01    0.10710E-04   0.800E+04     0.747
display                 0.12      3200    0.42767E+00    0.13365E-03   0.000E+00     0.000
read_inflow             0.07         1    0.23731E+00    0.23731E+00   0.000E+00     0.000
str_Nstep               0.04    320000    0.12284E+00    0.38389E-06   0.000E+00     0.000
wrt_SPHAvr              0.02         1    0.62635E-01    0.62635E-01   0.000E+00     0.000
setup_PDM               0.01         1    0.35180E-01    0.35180E-01   0.000E+00     0.000
wrt_Profile             0.01         1    0.32339E-01    0.32339E-01   0.000E+00     0.000
init_arrays             0.00         1    0.45991E-02    0.45991E-02   0.000E+00     0.000
meshing                 0.00         0    0.10000E-02       Infinity   0.902E+07     0.000
wrt_RCSIns              0.00         0    0.10000E-02       Infinity   0.000E+00     0.000
wrt_SPHIns              0.00         0    0.10000E-02       Infinity   0.000E+00     0.000
averaging               0.00         1    0.10000E-02    0.10000E-02   0.301E+07     3.005
stg2Node                0.00         0    0.10000E-02       Infinity   0.601E+07     0.000
wrt_RCSAvr              0.00         0    0.10000E-02       Infinity   0.000E+00     0.000
read_rst_file           0.00         0    0.10000E-02       Infinity   0.000E+00     0.000
~~~

346 sec

- UO, VOにも初期値を入れる修正後、期待どおりの結果

~~~
                Label  %Time      Call        accTime        avrTime   flop/call    Gflops
Uflux                  19.91    320000    0.65918E+02    0.20599E-03   0.160E+09   778.627
accumAvr               19.67    320000    0.65112E+02    0.20348E-03   0.301E+07    14.768
Poi_AXB                17.32    320005    0.57329E+02    0.17915E-03   0.210E+08   117.221
Vflux                  16.84    320000    0.55759E+02    0.17425E-03   0.160E+09   920.180
Poi_RHS                13.24    320000    0.43834E+02    0.13698E-03   0.105E+08    76.652
Update_Vec              7.37    320000    0.24413E+02    0.76290E-04   0.120E+08   157.164
Shift_Prs               3.23    320000    0.10682E+02    0.33381E-04   0.602E+07   180.344
BC_Prs                  1.11    320000    0.36707E+01    0.11471E-04   0.000E+00     0.000
BC_Vec                  1.06    320000    0.35199E+01    0.11000E-04   0.800E+04     0.727
display                 0.13      3200    0.42398E+00    0.13249E-03   0.000E+00     0.000
read_inflow             0.04         1    0.13073E+00    0.13073E+00   0.000E+00     0.000
wrt_SPHAvr              0.03         1    0.83560E-01    0.83560E-01   0.000E+00     0.000
str_Nstep               0.02    320000    0.68477E-01    0.21399E-06   0.000E+00     0.000
wrt_Profile             0.01         1    0.48325E-01    0.48325E-01   0.000E+00     0.000
setup_PDM               0.00         1    0.14189E-01    0.14189E-01   0.000E+00     0.000
init_arrays             0.00         1    0.66960E-02    0.66960E-02   0.000E+00     0.000
meshing                 0.00         0    0.10000E-02       Infinity   0.902E+07     0.000
wrt_RCSIns              0.00         0    0.10000E-02       Infinity   0.000E+00     0.000
wrt_SPHIns              0.00         0    0.10000E-02       Infinity   0.000E+00     0.000
averaging               0.00         1    0.10000E-02    0.10000E-02   0.301E+07     3.005
stg2Node                0.00         0    0.10000E-02       Infinity   0.601E+07     0.000
wrt_RCSAvr              0.00         0    0.10000E-02       Infinity   0.000E+00     0.000
read_rst_file           0.00         0    0.10000E-02       Infinity   0.000E+00     0.000
=================================================
Elapsed time =       0.331E+03
~~~



| # core | time (sec) | Speedup |
| ------ | ---------- | ------- |
| 1      | 7,074      | 1.0     |
| 2      | 3,529      | 2.00    |
| 4      | 1,729      | 4.09    |
| 6      | 1,360      | 5.20    |
| 8      | 913        | 7.75    |
| 10     | 815        | 8.68    |
| 12     | 657        | 10.7    |
| 14     | 583        | 12.13   |
| 16     | 556        | 12.72   |
| 18     | 493        | 14.35   |
| 20     | 458        | 15.45   |
| 22     | 430        | 16.45   |
| 24     | 411        | 17.21   |
| 26     | 390        | 18.14   |
| 28     | 386        | 18.33   |
| 30     | 374        | 18.91   |
| 32     | 350        | 20.21   |
| 34     | 337        | 20.99   |
| 36     | 330        | 21.44   |



`2dpdm6.f90`

- 出力用のU,Vを介さず、直接UU→ノードに補間、HUVWにストア
  - U, Vは不使用
  - UAVE, VAVEのレンジをUAVE(0:NX+2,0:NY+2)→UAVE(NX,NY)に戻す
  - accmAvr()でstg2Node()の計算を含め、UAVE, VAVEにはノードでの平均値を保存積算。各ステップの積算方式に変更。これに伴いavr_Vars()を削除x
  - wrt_SPHAvr()でUAVE, VAVEを出力
  - stg2Node()は不使用
- 平均開始時刻の指定
  - 平均値操作　渦の無次元輸送速度0.7として、XLEN(=15)/0.7=21.4  t=20で平均値操作の開始
  - 計算時間はt=320なので、t=300の時間平均

~~~
                Label  %Time      Call        accTime        avrTime   flop/call    Gflops
Uflux                  19.56    320000    0.61164E+02    0.19114E-03   0.160E+09   839.148
Poi_AXB                17.55    320005    0.54886E+02    0.17152E-03   0.210E+08   122.437
Vflux                  17.38    320000    0.54335E+02    0.16980E-03   0.160E+09   944.310
accumAvr               13.86    200001    0.43351E+02    0.21675E-03   0.150E+08    69.318
Poi_RHS                13.43    320000    0.42006E+02    0.13127E-03   0.105E+08    79.989
Update_Vec              8.15    320000    0.25484E+02    0.79638E-04   0.120E+08   150.556
Shift_Prs               3.45    320000    0.10786E+02    0.33705E-04   0.602E+07   178.608
wrt_SPHIns              2.23        80    0.69830E+01    0.87288E-01   0.601E+07     0.069
BC_Prs                  1.25    320000    0.39139E+01    0.12231E-04   0.000E+00     0.000
BC_Vec                  1.21    320000    0.37963E+01    0.11863E-04   0.800E+04     0.674
wrt_SPHAvr              1.02        50    0.31856E+01    0.63712E-01   0.000E+00     0.000
wrt_Profile             0.59        50    0.18439E+01    0.36878E-01   0.000E+00     0.000
display                 0.16      3200    0.49159E+00    0.15362E-03   0.000E+00     0.000
setup_PDM               0.07         1    0.21311E+00    0.21311E+00   0.000E+00     0.000
read_inflow             0.06         1    0.19197E+00    0.19197E+00   0.000E+00     0.000
str_Nstep               0.01    320000    0.26774E-01    0.83670E-07   0.000E+00     0.000
init_arrays             0.00         1    0.12253E-01    0.12253E-01   0.000E+00     0.000
read_rst_file           0.00         0    0.10000E-02       Infinity   0.000E+00     0.000
wrt_RCSIns              0.00         0    0.10000E-02       Infinity   0.601E+07     0.000
wrt_RCSAvr              0.00         0    0.10000E-02       Infinity   0.000E+00     0.000
meshing                 0.00         0    0.10000E-02       Infinity   0.902E+07     0.000
=================================================
Elapsed time =     0.31267E+03
~~~

- 時間平均の開始をt=120として計算したので、accmAvrの回数が少なくなりその分計算時間が短くなっている。また、実行速度自体も上がっている。
- しかし、時間平均の開始を変更したことで、速度欠損のプロファイルが変わっている。時間平均の影響かどうかを確認する→mdfy7
- accmVar()の加算で係数c1, c2を逆にしていた。修正。
- t=120からの平均化は同傾向ではあるが、少々平均時間が足りないために平均プロファイルは若干異なる。

##### mdfy7

- 平均開始をゼロスタートでオリジナルと合わせる
- accmVar()の加算で係数c1, c2を逆にしていた。修正。

##### rc1

- 動的アロケート、速度落ちている。やはり、コンパイル時にループ長を決めた方がいい。
- t=120のプロファイルはオリジナルとは若干ずれる。t=0から平均をとると、同じになることを確認済み

~~~
                Label  %Time      Call        accTime        avrTime   flop/call    Gflops
Uflux                  32.73    320000    0.17192E+03    0.53724E-03   0.160E+09   298.550
Vflux                  29.74    320000    0.15618E+03    0.48808E-03   0.160E+09   328.513
Poi_AXB                10.13    320005    0.53206E+02    0.16627E-03   0.210E+08   126.303
Poi_RHS                 8.53    320000    0.44778E+02    0.13993E-03   0.105E+08    75.037
accumAvr                8.12    200001    0.42667E+02    0.21333E-03   0.150E+08    70.429
Update_Vec              4.68    320000    0.24576E+02    0.76800E-04   0.120E+08   156.120
Shift_Prs               1.97    320000    0.10348E+02    0.32337E-04   0.602E+07   186.165
wrt_SPHIns              1.39        80    0.73089E+01    0.91362E-01   0.601E+07     0.066
BC_Prs                  0.77    320000    0.40220E+01    0.12569E-04   0.000E+00     0.000
BC_Vec                  0.72    320000    0.38039E+01    0.11887E-04   0.800E+04     0.673
wrt_SPHAvr              0.69        50    0.36248E+01    0.72496E-01   0.000E+00     0.000
wrt_Profile             0.35        50    0.18212E+01    0.36423E-01   0.000E+00     0.000
display                 0.07      3200    0.35817E+00    0.11193E-03   0.000E+00     0.000
History                 0.05      3200    0.24482E+00    0.76505E-04   0.000E+00     0.000
read_inflow             0.04         1    0.19876E+00    0.19876E+00   0.000E+00     0.000
str_Nstep               0.01    320000    0.68354E-01    0.21361E-06   0.000E+00     0.000
setup_PDM               0.01         1    0.53601E-01    0.53601E-01   0.000E+00     0.000
init_arrays             0.00         1    0.63031E-02    0.63031E-02   0.000E+00     0.000
wrt_RCSIns              0.00         0    0.10000E-02       Infinity   0.601E+07     0.000
wrt_RCSAvr              0.00         0    0.10000E-02       Infinity   0.000E+00     0.000
meshing                 0.00         0    0.10000E-02       Infinity   0.902E+07     0.000
read_rst_file           0.00         0    0.10000E-02       Infinity   0.000E+00     0.000
=================================================
Elapsed time =     0.52519E+03
~~~

##### rc2

- rc1のCompile&Go版
- モジュールの使い方が良くない？速度遅い

~~~
                Label  %Time      Call        accTime        avrTime   flop/call    Gflops
Uflux                  29.48    320000    0.16225E+03    0.50703E-03   0.160E+09   316.341
Vflux                  28.17    320000    0.15505E+03    0.48452E-03   0.160E+09   330.923
accumAvr               12.63    320000    0.69499E+02    0.21718E-03   0.150E+08    69.181
Poi_AXB                10.25    320005    0.56432E+02    0.17635E-03   0.210E+08   119.082
Poi_RHS                 8.81    320000    0.48512E+02    0.15160E-03   0.105E+08    69.261
Update_Vec              4.62    320000    0.25430E+02    0.79469E-04   0.120E+08   150.876
Shift_Prs               1.85    320000    0.10189E+02    0.31841E-04   0.602E+07   189.067
wrt_SPHIns              1.17        80    0.64643E+01    0.80804E-01   0.601E+07     0.074
wrt_SPHAvr              1.08        80    0.59710E+01    0.74637E-01   0.000E+00     0.000
BC_Prs                  0.69    320000    0.38077E+01    0.11899E-04   0.000E+00     0.000
BC_Vec                  0.65    320000    0.35911E+01    0.11222E-04   0.800E+04     0.713
wrt_Profile             0.43        80    0.23577E+01    0.29471E-01   0.000E+00     0.000
read_inflow             0.05         1    0.29068E+00    0.29068E+00   0.000E+00     0.000
display                 0.05      3200    0.27221E+00    0.85064E-04   0.000E+00     0.000
History                 0.03      3200    0.14145E+00    0.44205E-04   0.000E+00     0.000
str_Nstep               0.02    320000    0.91873E-01    0.28710E-06   0.000E+00     0.000
setup_PDM               0.01         1    0.54382E-01    0.54382E-01   0.000E+00     0.000
init_arrays             0.00         1    0.75259E-02    0.75259E-02   0.000E+00     0.000
wrt_RCSIns              0.00         0    0.10000E-02       Infinity   0.601E+07     0.000
wrt_RCSAvr              0.00         0    0.10000E-02       Infinity   0.000E+00     0.000
meshing                 0.00         0    0.10000E-02       Infinity   0.902E+07     0.000
read_rst_file           0.00         0    0.10000E-02       Infinity   0.000E+00     0.000
=================================================
Elapsed time =     0.55041E+03
~~~



##### rc3

- モジュールにUU,UOを含めると、配列の型やポインタ属性の整合性がとれず、遅い実装か正しくない計算になるため、UU, UOをモジュールの外に出す。mainでポインタ属性でアロケートしてもサブルーチン側の宣言で配列の大きさが決まっていればコンパイルが最適化されるようだ。
- 5Dのプロファイルも一致していることを確認

~~~
                Label  %Time      Call        accTime        avrTime   flop/call    Gflops
accumAvr               18.94    320000    0.66425E+02    0.20758E-03   0.150E+08    72.383
Uflux                  18.11    320000    0.63516E+02    0.19849E-03   0.160E+09   808.073
Poi_AXB                16.36    320005    0.57388E+02    0.17934E-03   0.210E+08   117.099
Vflux                  15.24    320000    0.53448E+02    0.16702E-03   0.160E+09   959.975
Poi_RHS                12.26    320000    0.43002E+02    0.13438E-03   0.105E+08    78.135
Update_Vec              9.40    320000    0.32973E+02    0.10304E-03   0.120E+08   116.361
Shift_Prs               3.18    320000    0.11157E+02    0.34864E-04   0.602E+07   172.671
wrt_SPHIns              1.86        80    0.65190E+01    0.81488E-01   0.601E+07     0.074
wrt_SPHAvr              1.35        80    0.47356E+01    0.59195E-01   0.000E+00     0.000
BC_Prs                  1.19    320000    0.41731E+01    0.13041E-04   0.000E+00     0.000
BC_Vec                  1.14    320000    0.39946E+01    0.12483E-04   0.800E+04     0.641
wrt_Profile             0.75        80    0.26468E+01    0.33085E-01   0.000E+00     0.000
display                 0.08      3200    0.26635E+00    0.83234E-04   0.000E+00     0.000
read_inflow             0.06         1    0.20061E+00    0.20061E+00   0.000E+00     0.000
History                 0.04      3200    0.14034E+00    0.43856E-04   0.000E+00     0.000
str_Nstep               0.01    320000    0.48955E-01    0.15299E-06   0.000E+00     0.000
setup_PDM               0.01         1    0.42046E-01    0.42046E-01   0.000E+00     0.000
init_arrays             0.00         1    0.70491E-02    0.70491E-02   0.000E+00     0.000
wrt_RCSIns              0.00         0    0.10000E-02       Infinity   0.601E+07     0.000
wrt_RCSAvr              0.00         0    0.10000E-02       Infinity   0.000E+00     0.000
meshing                 0.00         0    0.10000E-02       Infinity   0.902E+07     0.000
read_rst_file           0.00         0    0.10000E-02       Infinity   0.000E+00     0.000
=================================================
Elapsed time =     0.35069E+03
~~~

##### rc4

- オリジナルの問題設定
- 無次元量：X=15, Y=10, Re=$10^4$​​, dx=0.01,ローター径D=150セルx0.01=1.5? 
- ローター径で無次元化するのであれば、100セルのはずではないか？5D位置（上流から10D）が1000格子目なので、1D=100格子の計算のはず
  - **→「受風面内に抵抗係数を与えるとどうしても工学モデルと一致しないため、試行錯誤により以下の範囲で与えることを見い出している状況」**ということなので、モデル改善の余地あり
- この設定ではX=10D, Y=10/1.5=6.67D
- dx=0.01, dt=0.001なのでクーラン数0.1, $c=u\Delta t/\Delta x$→$\Delta t=c\Delta x/u=0.1\times 0.01/1=0.001$
- ブレード厚さは2dxなので0.02. dx=1/100 D
- $\nu=1.5\times 10^{-5}$（空気）として、UL=0.15となる。風洞実験を考えてL=0.5mとすると、U=0.3m/s
- 有次元：L=0.5m, U=0.3m/s　→　X=7.5m, Y=5m, diameter=0.5x1.5=0.75m cord=0.03x0.5=0.015m, dx=0.005m
  - オリジナルパラメータどおりにするなら、Y=
- 入力パラメータを有次元ベースに変更
  - primary : U, L, X, Y, NX, Ny, Courant数
- PFUNCは$y=\frac{1}{2}\big( cos(2\pi x-\pi) + 1 \big)$で作成
- 結果がオリジナルと同じことを確認

~~~
                Label  %Time      Call        accTime        avrTime   flop/call    Gflops
accumAvr               18.89    320000    0.63853E+02    0.19954E-03   0.150E+08    75.298
Poi_AXB                16.20    320005    0.54750E+02    0.17109E-03   0.210E+08   122.743
Uflux                  14.76    320000    0.49894E+02    0.15592E-03   0.160E+09  1028.689
Vflux                  14.41    320000    0.48695E+02    0.15217E-03   0.160E+09  1053.670
Poi_RHS                10.45    320000    0.35314E+02    0.11036E-03   0.105E+08    95.146
Update_Vec              9.67    320000    0.32704E+02    0.10220E-03   0.120E+08   117.320
History                 5.37    320000    0.18150E+02    0.56719E-04   0.000E+00     0.000
Shift_Prs               3.32    320000    0.11216E+02    0.35051E-04   0.602E+07   171.751
wrt_SPHIns              2.05        80    0.69379E+01    0.86724E-01   0.601E+07     0.069
wrt_SPHAvr              1.51        80    0.51162E+01    0.63952E-01   0.000E+00     0.000
BC_Prs                  1.26    320000    0.42703E+01    0.13345E-04   0.000E+00     0.000
BC_Vec                  1.19    320000    0.40066E+01    0.12521E-04   0.800E+04     0.639
wrt_Profile             0.78        80    0.26514E+01    0.33142E-01   0.000E+00     0.000
display                 0.07      3200    0.23798E+00    0.74367E-04   0.000E+00     0.000
read_inflow             0.04         1    0.14551E+00    0.14551E+00   0.000E+00     0.000
str_Nstep               0.02    320000    0.62702E-01    0.19594E-06   0.000E+00     0.000
setup_PDM               0.00         1    0.78731E-02    0.78731E-02   0.000E+00     0.000
init_arrays             0.00         1    0.67270E-02    0.67270E-02   0.000E+00     0.000
wrt_RCSIns              0.00         0    0.10000E-02       Infinity   0.601E+07     0.000
wrt_RCSAvr              0.00         0    0.10000E-02       Infinity   0.000E+00     0.000
meshing                 0.00         0    0.10000E-02       Infinity   0.902E+07     0.000
read_rst_file           0.00         0    0.10000E-02       Infinity   0.000E+00     0.000
=================================================
Elapsed time =     0.33802E+03
~~~

##### rc5

- rc4のパラメータで風車直径を1.5→1.0に変更したもの

##### rc6

- rc4のパラメータで圧力損失分布をフラットにしたもの

##### rc7

- rc4のパラメータで圧力損失分布を疑似ダブルガウシアンにしたもの

##### rc8

- rc6のパラメータで風車直径を1.5→1.0に変更したもの
- rc4-rc8を比較するとブロッケージ効果で外側の流速が上がっているよう。これは側面境界条件で変わるはず。トラクションフリーを試す。
- PDMは透過的な圧力損失なので、物体があるときのような流れの回り込みは生じない。このため、渦が出来ずにエントレインメントや非定常性が強く出てこない。

##### rc9

- トラクションフリー条件で、rc4のパラメータで計算

##### rc10

- トラクションフリーで、rc5のパラメータ
- トラクションフリーでは側方境界で変動を強制していないので、自然に流入出するだけ。このため、混合が不足し、裾野が狭い
- 側方境界条件の影響は大きい。

##### rc11

- [Json-fortranの記事](https://libertytree-seek.com/technology/2308/)を参考にパーサーを実装
- [Github](https://github.com/jacobwilliams/json-fortran)からソースをダウンロードし、"json-fortran"のディレクトリ名でsrcディレクトリと並置する

~~~
% tree .
.
├── json-fortran
│   ├── CHANGELOG.md
│   ├── CMakeLists.txt
│   ├── LICENSE
│   ├── README.md
│   ├── build.sh
│   ├── cmake
│   ├── codecov.yml
│   ├── files
│   ├── fpm.toml
│   ├── json-fortran.code-workspace
│   ├── json-fortran.fobis
│   ├── json-fortran.md
│   ├── json-fortran.pc.cmake.in
│   ├── media
│   ├── pages
│   ├── src
│   │   ├── Makefile
│   │   ├── include
│   │   ├── json_file_module.F90
│   │   ├── json_get_scalar_by_path.inc
│   │   ├── json_get_vec_by_path.inc
│   │   ├── json_get_vec_by_path_alloc.inc
│   │   ├── json_initialize_arguments.inc
│   │   ├── json_initialize_dummy_arguments.inc
│   │   ├── json_kinds.F90
│   │   ├── json_macros.inc
│   │   ├── json_module.F90
│   │   ├── json_parameters.F90
│   │   ├── json_string_utilities.F90
│   │   ├── json_value_module.F90
│   │   ├── lib
│   │   ├── test
│   │   └── tests
│   │       ├── introspection
│   │       │   └── test_iso_10646_support.f90
│   │       ├── jf_test_01.F90
│   │       ├── jf_test_02.F90
│   │       ├── jf_test_03.F90
│   │       │   ...
│   │       └── jf_test_49.F90
│   └── visual_studio
├── src
│   ├── Makefile
│   ├── param.fi
│   ├── rc2d.f90
│   ├── rc2d_fileio.f90
│   ├── rc2d_pm.f90
│   ├── rc2d_prs.f90
│   ├── rc2d_util.f90
│   ├── rc2d_vector.f90
│   ├── rc_wake.f90
│   └── size.fi
~~~

- Json-fortran/src/Makefileを実行すると、include, libディレクトリにそれぞれファイルとstatic libraryが生成される
- 

### TODO

- Crank-Nicholson scheme　→$\Delta t$​を大きく
  - ALMでは翼端速度がTSR=4なら、$\Delta t$​が1/4になる。物体移動を1セル超えては与えられないので、RK2やAB2の方がよいかも。粘性を持ち込まない時間進行スキームがいい

- Picard反復
- WCNS scheme
- Keep scheme
- 2DALMとポーラスモデルの比較
- 2DALM<>3DALM
- 高解像度スキームによる格子点削減
- PDMの浮体対応
- 出力ラインの指定（5Dなど）
- [Jsonパーサー](https://libertytree-seek.com/technology/2308/)
- 乱流流入境界条件
  - forcingで所望の乱流強度
- サマリファイル　計算の条件メモ=> DBでの参照
- ボスをffvのファンと同様に実装。PDMの力はかけない
- トラクションフリー



##### 計算領域

- 上流、横方向に5D
- 下流は風車より20D
- データサンプリングラインは風車より10Dなど
- 例えば、
  - 単基だとX:25D, Y:10D
  - 2基では配置にもよるが、並列に5D離れるとY:15D、流れ方向に5D離れるとX:30Dとなる
- テスト計算では$\Delta x=0.01$（風車に100点）、X:15D, Y:10Dなので、上記の30Dx15Dなので3倍の格子数
- 3倍の格子数だと36コアで1ケース20分程度。
- 計算時間はもう少し少なくしたいので、$\Delta x=0.02$程度の粗い格子が使える高解像度スキーム(WCNS5)を導入





#### Production Run

- 複数風車の計算
  - 位置情報、風車情報を与える
  - 格子を作成　→　等間隔　or　不等間隔
  - 直交の場合、計算領域により格子数が決まる（$\Delta x$固定）どれくらいまで計算できるか？
  - 不等間隔の場合、風車周りの等間隔領域の設定、ストレッチ部分の生成　手作業？　自動化できる？
- 評価をどのように進めるか？
  - 風車面の速度欠損量
  - 2D <> 3Dの相関
  - パワーカーブから発電量予測
  - 係数の算出
    - ３D計算から
    - ±5度＋13.0
  - 2D -> 3Dへの推定　後ほど
- 計算規模



125基はエジプトのボスワンサイト　SCADAデータあり　＞　大体あっている検証結果あり

風車のハブ中心手前のの平均風速を比較

2基　風洞で実験　＞　比較

5ｘ5程度まで

論文ベースのデータと比較　（内田先生から入手）





2024-02-14 東大のAquarius申請